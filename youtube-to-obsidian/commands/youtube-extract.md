---
name: youtube-extract
description: YouTube URL에서 자막을 추출하여 Obsidian 마크다운 문서로 변환
argument-hint: <YouTube_URL> [추가 URL...]
allowed-tools:
  - Bash
  - Read
  - Write
  - Edit
  - Task
---

# YouTube 자막 추출 및 Obsidian 문서 변환

YouTube URL을 받아 자막을 다운로드하고, Obsidian 스타일의 구조화된 마크다운 문서로 변환한다.

> [!critical] 핵심 원칙 (필수 준수)
> 1. **임시 폴더 위치**: 모든 임시 작업은 **현재 작업 디렉토리** 기준 `./_youtube_work_*` 폴더에서 수행해야 한다.
>    - **절대 금지**: `$USERPROFILE/AppData/Local/Temp/` 또는 시스템 임시 폴더 사용 금지
>    - **이유**: filesystem MCP 권한 범위 밖이므로 파일 접근 오류 발생
> 2. **Obsidian 보호**: 최종 완성된 파일만 `00_Inbox/`로 이동 (Obsidian 자동 수정 방지)
> 3. **병렬 처리**: 여러 URL이 제공되면 각 URL을 별도의 서브에이전트에서 병렬로 처리한다.

## 워크플로우

### 0단계: URL 파싱 및 병렬 처리 결정

인자로 받은 URL 목록을 파싱한다:
- 공백이나 줄바꿈으로 구분된 여러 URL 지원
- 각 URL이 유효한 YouTube URL인지 확인

**여러 URL이 제공된 경우:**
```
Task 도구를 사용하여 각 URL을 별도의 서브에이전트에서 병렬로 처리한다.
각 서브에이전트에게는 단일 URL과 함께 아래 "단일 URL 처리 지침"을 전달한다.
서브에이전트는 run_in_background: true 옵션으로 병렬 실행한다.
```

**단일 URL인 경우:**
직접 아래 단계를 수행한다.

---

## 단일 URL 처리 지침

### 1단계: 임시 작업 폴더 생성

> [!warning] 임시 폴더 위치 필수 준수
> 반드시 **현재 작업 디렉토리** 기준으로 임시 폴더를 생성해야 한다.
> - 시스템 임시 폴더(`$USERPROFILE/AppData/Local/Temp/` 등) 사용 금지
> - 이 규칙을 무시하면 filesystem MCP 권한 오류가 발생함

```bash
# 임시 작업 폴더 생성 (현재 디렉토리 기준 - 필수!)
WORK_DIR="./_youtube_work_$(date +%s)"
mkdir -p "$WORK_DIR"
echo "작업 폴더: $(pwd)/$WORK_DIR"
```

생성된 폴더의 절대 경로를 확인하고, 이후 모든 작업에서 이 경로를 사용한다.

### 2단계: YouTube URL 검증

URL이 유효한 YouTube URL인지 확인한다:
- `youtube.com/watch?v=` 형식
- `youtu.be/` 형식
- `youtube.com/shorts/` 형식

URL이 없거나 유효하지 않으면 사용자에게 안내한다.

### 3단계: 자막 다운로드 (임시 폴더에)

yt-dlp를 사용하여 **임시 폴더**에 자막을 다운로드한다. 한국어 자막 우선, 없으면 영어 자막을 다운로드한다.

```bash
# 한국어 자막 다운로드 시도 (임시 폴더에)
yt-dlp --write-sub --write-auto-sub --sub-lang ko --sub-format vtt --skip-download -o "$WORK_DIR/%(title)s [%(id)s]" "<YouTube_URL>"
```

한국어 자막이 없는 경우:
```bash
# 영어 자막 다운로드 (임시 폴더에)
yt-dlp --write-sub --write-auto-sub --sub-lang en --sub-format vtt --skip-download -o "$WORK_DIR/%(title)s [%(id)s]" "<YouTube_URL>"
```

### 4단계: VTT를 마크다운으로 변환 (임시 폴더에서)

임시 폴더의 VTT 파일을 찾아 파이썬 스크립트로 변환한다.

> [!important] VTT 파일은 Read 도구로 직접 읽지 않는다
> VTT 파일은 토큰 제한을 초과할 수 있으므로, 반드시 파이썬 스크립트를 사용하여 변환한다.

```bash
# VTT 파일 찾기 (임시 폴더에서)
VTT_FILE=$(ls -t "$WORK_DIR"/*.vtt | head -1)

# 스크립트 경로 (플러그인 루트 변수 사용 - find 탐색 불필요)
SCRIPT_PATH="${CLAUDE_PLUGIN_ROOT}/scripts/vtt_to_markdown.py"

# 마크다운 변환 (VTT 파일 삭제 포함)
PYTHONIOENCODING=utf-8 uv run "$SCRIPT_PATH" "$VTT_FILE" --delete-vtt
```

스크립트 실행 후 생성된 마크다운 파일을 Read 도구로 읽어서 다음 단계를 진행한다.

### 5단계: 영어 자막 번역 (필요시)

영어 자막인 경우, **임시 폴더의** 마크다운 파일을 읽어 한국어로 번역한다:
1. 임시 폴더의 마크다운 파일을 Read 도구로 읽는다
2. 자막 내용 섹션의 텍스트를 한국어로 번역한다
3. Write 도구로 번역된 내용을 임시 폴더에 저장한다
4. 언어 표시를 "영어 (번역됨)"으로 변경한다

### 6단계: Obsidian 스타일로 문서 재구성 (핵심)

**임시 폴더의** 마크다운 파일을 읽고 Obsidian 스타일에 맞게 전면 재구성한다.

#### 6.1 문서 구조 재구성

타임스탬프별 자막을 의미 있는 섹션으로 재구성:
- 영상 내용을 분석하여 주제별로 섹션 분리
- `## 주요 섹션 제목` (H2)으로 큰 주제 구분
- `### 세부 항목` (H3)으로 세부 내용 구분
- 타임스탬프는 각주로 이동하거나 섹션 시작에만 표시

#### 6.2 콜아웃 추가

핵심 정보와 중요 내용에 Obsidian 콜아웃 적용:
```markdown
> [!important] 핵심 포인트
> 가장 중요한 내용 요약

> [!note] 참고
> 부가 설명이나 배경 정보

> [!warning] 주의
> 경고나 위험 요소

> [!tip] 팁
> 유용한 정보나 조언

> [!quote] 인용
> 영상에서 인용할 만한 문구
```

#### 6.3 표 활용

비교, 목록, 통계 정보는 표로 정리:
```markdown
| 항목 | 설명 | 비고 |
|------|------|------|
| 내용1 | 설명1 | 참고1 |
```

#### 6.4 내부 링크 추가

주요 인물, 기관, 개념에 Obsidian 내부 링크 적용:
- 인물: `[[홍길동]]`, `[[일론 머스크]]`
- 기관/기업: `[[삼성전자]]`, `[[미국 연준]]`
- 개념: `[[인플레이션]]`, `[[양적완화]]`

#### 6.5 개요 섹션 추가

문서 상단에 개요 섹션 추가:
```markdown
## 개요

이 영상은 [주제]에 대해 다룹니다. 주요 내용은 다음과 같습니다:
- 핵심 포인트 1
- 핵심 포인트 2
- 핵심 포인트 3
```

#### 6.6 태그 상세화

문서 하단의 태그를 영상 내용에 맞게 구체화:
```markdown
---

**태그**: #유튜브 #[주제카테고리] #[세부주제1] #[세부주제2] #[인물명]
```

예시: `#유튜브 #국제관계 #미얀마 #제재 #무기거래 #북한`

#### 6.7 브레드크럼 추가 (선택)

저장될 폴더에 맞는 브레드크럼 네비게이션 추가:
```markdown
> [[03_Resources/폴더명/인덱스파일|상위폴더]] > 현재문서
```

#### 6.8 핵심 장면 이미지 추출 (선택)

자막 내용을 분석하여 시각적 설명이 포함된 핵심 장면의 이미지를 추출한다.

##### 6.8.1 핵심 장면 판단 (Claude가 수행)

6단계 문서 재구성 과정에서 자막 내용을 읽으며 **텍스트만으로는 이해하기 어려운 시각적 설명**이 포함된 시간대를 식별한다.

핵심 장면 판단 기준:
- **다이어그램/그래프 설명**: "이 그림을 보면", "차트에서 보듯이" 등 시각 자료 참조
- **비유/예시의 시각화**: 미로, 동전, 호수 등 추상적 개념을 시각적으로 설명하는 부분
- **단계별 프로세스**: 순서도나 흐름이 있는 설명
- **비교 대조**: 두 개념을 나란히 비교하는 부분 (예: 고전 비트 vs 큐비트)
- **수치/데이터 시각화**: 통계, 그래프, 표가 언급되는 부분

> [!important] 판단 원칙
> 모든 장면을 추출하는 것이 아니라, **텍스트만으로 이해가 어렵고 이미지가 있으면 이해에 도움이 되는 장면**만 선별한다.

##### 6.8.2 사용자에게 통보

분석 결과를 바탕으로 추출할 장면 목록을 사용자에게 **통보**한다 (확인 대기 없음):

```markdown
다음 핵심 장면의 이미지를 추출합니다:

| 시간 | 내용 |
|------|------|
| 0:10 | 미로 비유 설명 |
| 1:40 | 블로흐 구 다이어그램 |
| 3:07 | 오라클 단계 시각화 |
```

##### 6.8.3 영상 다운로드 및 장면 변화 감지 추출

> [!note] 장면 변화 감지 (Scene Detection) 방식
> 자막 텍스트의 시간과 실제 시각 자료가 표시되는 시간이 다를 수 있으므로,
> 지정된 시간 근처에서 **장면이 변하는 시점**(슬라이드/그래프 전환)을 자동 감지하여 추출한다.

```bash
# 필요한 구간만 영상 다운로드 (시작~마지막 키프레임+10초)
# 360p 우선, 없으면 480p, 720p 순으로 폴백
yt-dlp -f "best[height<=360]/best[height<=480]/best[height<=720]" --download-sections "*0:00-<END_TIME>" -o "$WORK_DIR/video.mp4" "<YouTube_URL>"

# 각 시간대 근처(±5초)에서 장면 변화 감지하여 프레임 추출
# T = 목표 시간(초), scene 임계값 0.3으로 장면 변화 감지
ffmpeg -ss $((T-5)) -t 10 -i "$WORK_DIR/video.mp4" \
  -vf "select='gt(scene,0.3)'" -vsync vfr \
  -frames:v 1 -q:v 2 "$WORK_DIR/<filename>.jpg" -y
```

장면 변화가 감지되지 않는 경우 (예: 토킹헤드 영상), 기존 방식으로 폴백:
```bash
# 폴백: 지정 시간의 단일 프레임 추출
ffmpeg -ss <SECONDS> -i "$WORK_DIR/video.mp4" -frames:v 1 -q:v 2 -update 1 "$WORK_DIR/<filename>.jpg" -y
```

파일명 규칙: `<video_id>_<index>_<seconds>s.jpg`
예시: `kSjySvJMdFo_01_10s.jpg`, `kSjySvJMdFo_02_100s.jpg`

##### 6.8.4 이미지를 첨부파일 폴더로 이동

```bash
# 추출된 이미지를 Obsidian 첨부파일 폴더로 이동
mv "$WORK_DIR"/*.jpg "05_Attachments/첨부파일/"
```

##### 6.8.5 문서에 이미지 삽입

마크다운 문서의 적절한 위치에 이미지와 타임스탬프 캡션을 삽입한다:

```markdown
![[kSjySvJMdFo_01_10s.jpg]]
*[0:10](https://youtu.be/kSjySvJMdFo?t=10) - 미로에 물을 붓는 비유*
```

캡션 형식:
- 타임스탬프는 YouTube 링크로 연결 (클릭 시 해당 시간으로 이동)
- 이탤릭체로 표시
- 간단한 설명 포함

### 7단계: 최종 파일을 00_Inbox로 이동

재구성이 완료된 최종 파일을 Obsidian vault의 `00_Inbox/` 폴더로 이동한다.

> [!important] 이미지 추출 여부에 따른 처리 분기
> - **이미지 추출 없음**: 마크다운 이동 후 작업폴더 즉시 삭제
> - **이미지 추출 있음**: 마크다운 이동 후 **작업폴더 유지**, 사용자 확인 후 삭제

#### 7.1 이미지 추출이 없는 경우

```bash
# 임시 폴더의 마크다운 파일을 00_Inbox로 이동
MD_FILE=$(ls -t "$WORK_DIR"/*.md | head -1)
mv "$MD_FILE" "00_Inbox/"

# 임시 폴더 정리 (즉시)
rm -rf "$WORK_DIR"
```

#### 7.2 이미지 추출이 있는 경우

```bash
# 임시 폴더의 마크다운 파일을 00_Inbox로 이동
MD_FILE=$(ls -t "$WORK_DIR"/*.md | head -1)
mv "$MD_FILE" "00_Inbox/"

# 작업폴더는 삭제하지 않음 (영상 파일 유지)
# 사용자가 이미지 확인 후 수동으로 삭제 요청
```

### 8단계: 완료 안내 및 이미지 확인 요청

재구성 완료 후 사용자에게 다음 정보를 안내한다:
- 생성된 파일 경로
- 파일 제목
- 재구성된 섹션 구조
- 추가 작업 안내 (폴더 이동, 부모 문서 링크 추가 등)

#### 8.1 이미지 추출이 있는 경우 추가 안내

이미지가 추출된 경우, 사용자에게 **이미지 확인 요청**을 표시한다:

```markdown
## 이미지 확인 요청

추출된 이미지가 적절한지 Obsidian에서 확인해주세요.

| 이미지 | 시간 | 설명 |
|--------|------|------|
| `RKl6NZ2msTg_01_58s.jpg` | 0:58 | PostgreSQL 아키텍처 |
| `RKl6NZ2msTg_02_143s.jpg` | 2:23 | PgBouncer 커넥션 풀링 |

**수정이 필요한 경우:**
- 시간 수정: "커넥션 풀링 이미지는 2:30으로 수정"
- 이미지 삭제: "Cosmos DB 이미지는 제거"
- 추가 추출: "3:45 시점 이미지 추가"

**확인 완료 시:**
- "수정완료" 또는 "이미지 확인 완료"라고 입력하면 작업폴더를 삭제합니다.

> 작업폴더: `$WORK_DIR` (영상 파일 보관 중)
```

사용자가 "수정완료" 또는 이미지 확인이 끝났다고 응답하면:
```bash
# 작업폴더 정리
rm -rf "$WORK_DIR"
```

---

## 병렬 처리 예시

여러 URL이 제공된 경우 Task 도구를 사용하여 병렬 처리:

```
여러 URL 예시: URL1 URL2 URL3

각 URL에 대해 Task 도구를 병렬로 호출:
- subagent_type: "general-purpose"
- run_in_background: true
- prompt: |
    YouTube 자막 추출 작업을 수행하세요.

    URL: <URL>
    작업 디렉토리: <현재 작업 디렉토리>

    [중요] 임시 폴더는 반드시 현재 작업 디렉토리 기준으로 생성해야 합니다.
    $USERPROFILE/AppData/Local/Temp/ 사용 금지 (filesystem MCP 권한 오류 발생)

    다음 단계를 따르세요:
    1. 임시 폴더 생성: WORK_DIR="./_youtube_work_$(date +%s)" (현재 디렉토리 기준!)
    2. 자막 다운로드 (한국어 우선, 없으면 영어)
    3. 파이썬 스크립트로 VTT를 마크다운으로 변환 (VTT 파일 직접 Read 금지)
    4. 영어인 경우 번역
    5. Obsidian 스타일로 재구성 (콜아웃, 표, 내부링크, 개요, 태그)
    6. 최종 파일을 00_Inbox/로 이동
    7. 완료 시 파일명 보고

모든 서브에이전트 완료 후 TaskOutput으로 결과 수집하여 사용자에게 보고한다.
```

---

## Obsidian 재구성 예시

### 재구성 전 (타임스탬프 나열)
```markdown
**[00:14.01]** 2023년 미얀마에 본사를 둔 기업인
**[00:17.02]** 로얄 슌 레이의 카우 투 묘 마인트와...
**[00:20.75]** 미얀마 군부에 공급될 무기거래를 위해...
```

### 재구성 후 (구조화된 문서)
```markdown
## 개요

이 영상은 미얀마 내전과 관련된 무기 거래의 국제적 연결고리를 추적합니다.

## 미얀마-북한 무기 거래

### 베이징 회동 (2023년)

2023년 [[미얀마]] 기업 로얄 슌 레이(Royal Shune Lei)의 대표들이 [[북한]]의
[[조선광업개발무역회사]](KOMID) 베이징 주재 부대표 김영주와 회동했다.

> [!important] 핵심 거래 내용
> 공중폭탄 유도 키트 공급 합의 - 기존 자유낙하 폭탄을 정밀유도폭탄으로 전환

### 거래 품목: 공중폭탄 유도 키트

| 특성 | 설명 |
|------|------|
| 기능 | GPS 유도 방식으로 폭탄 정밀화 |
| 위험성 | 범위 피해 예측 불가, 민간인 피해 우려 |
| 비용 | 저비용으로 대량 폭격 가능 |

---

**태그**: #유튜브 #국제관계 #미얀마 #북한 #무기거래 #제재
```

---

## 중요 사항

> [!danger] 임시 폴더 위치 규칙 (최우선 준수)
> - 임시 폴더는 **반드시** 현재 작업 디렉토리 기준 `./_youtube_work_*` 형식으로 생성
> - `$USERPROFILE/AppData/Local/Temp/` 또는 기타 시스템 임시 폴더 **절대 사용 금지**
> - 이 규칙 위반 시 filesystem MCP 권한 오류로 작업 실패

1. **임시 폴더 위치**: 현재 작업 디렉토리의 `./_youtube_work_*` 폴더에서 수행
2. **최종 파일만 이동**: 재구성 완료 후 `00_Inbox/`로 이동
3. **VTT 삭제**: 변환 완료 후 원본 VTT 파일은 자동 삭제
4. **재구성 필수**: 단순 변환이 아닌 Obsidian 스타일 재구성까지 완료해야 함
5. **내용 이해**: 자막 내용을 이해하고 의미 있는 섹션으로 구조화
6. **링크 연결**: 주요 인물/기관/개념에 내부 링크 적용
7. **병렬 처리**: 여러 URL은 서브에이전트로 병렬 처리
8. **이미지 추출**: 장면 변화 감지(Scene Detection) 방식으로 시각 자료 전환 시점 자동 포착
9. **이미지 확인**: 이미지 추출 시 작업폴더 유지, 사용자 확인 후 삭제 (시간 수정/재추출 가능)
10. **이미지 캡션**: 타임스탬프는 YouTube 링크로 연결하여 클릭 시 해당 시간으로 이동

## 오류 처리

- yt-dlp가 설치되지 않은 경우: 설치 방법 안내
- 자막이 없는 영상: 사용자에게 안내
- 네트워크 오류: 재시도 또는 URL 확인 요청
- 임시 폴더 생성 실패: 대체 경로 시도
- ffmpeg가 설치되지 않은 경우: 이미지 추출 단계 건너뛰고 안내
- 이미지 추출 실패: 문서 생성은 계속 진행, 이미지 없이 완료
